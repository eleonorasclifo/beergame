<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Overconfidence & Beer Game</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px; }
    .hidden { display: none; }
    .section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 { color: #2c3e50; }
    label, p { margin: 10px 0 5px; }
    input, select, button { margin: 5px 0 15px; padding: 8px; width: 100%; max-width: 400px; }
    /* bordo rosso per i campi mancanti */
    .required-error { border: 2px solid red !important; }
    button { background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #2980b9; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    /* Stili per la tabella nella sezione di gioco */
    #gameSection table { width: auto; border: none; margin: 10px 0; }
    #gameSection td { border: none; padding: 6px; }
    #gameSection td:first-child { text-align: right; white-space: nowrap; padding-right: 10px; }
  </style>

  <!-- SheetJS per leggere XLSX in JavaScript -->
  <script src="https://cdn.sheetjs.com/xlsx-0.18.7/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- ========================= Nickname Section ========================= -->
  <div class="section" id="nicknameSection">
    <h2>Enter your nickname</h2>
    <input type="text" id="nickname" placeholder="Nickname" />
    <button onclick="startOverestimation()">Start</button>
  </div>

  <!-- ========================= Admin Panel ========================= -->
  <div class="section hidden" id="adminSection">
    <h2>Admin Panel</h2>
    <!-- Bottone per scaricare direttamente l’XLSX pubblicato -->
    <button onclick="downloadSheet()">Download Google Sheet XLSX</button>
    <table>
      <thead>
        <tr>
          <th>Nickname</th>
          <th>Estimated Score</th>
          <th>Quiz Score</th>
          <th>Overconfidence %</th>
          <th>Total Cost</th>
        </tr>
      </thead>
      <tbody id="adminTable">
        <!-- Qui verranno inserite le righe lette dall’XLSX -->
      </tbody>
    </table>
  </div>

  <!-- ========================= Overestimation Section ========================= -->
  <div class="section hidden" id="overestimationSection">
    <h2>Overestimation Calculation</h2>
    <label>1. How many answers do you think you got right out of 5?<span style="color:red;"> *</span></label>
    <input type="number" id="estimatedScore" min="0" max="5" placeholder="0–5" />

    <p>2. What is the capital of Australia?<span style="color:red;"> *</span></p>
    <select id="q1">
      <option value="" selected>Choose an option</option>
      <option>Sydney</option>
      <option>Canberra</option>
      <option>Melbourne</option>
      <option>Brisbane</option>
    </select>

    <p>3. What is 12 × 8?<span style="color:red;"> *</span></p>
    <select id="q2">
      <option value="" selected>Choose an option</option>
      <option>80</option>
      <option>96</option>
      <option>108</option>
      <option>92</option>
    </select>

    <p>4. In what year was Google founded?<span style="color:red;"> *</span></p>
    <select id="q3">
      <option value="" selected>Choose an option</option>
      <option>1996</option>
      <option>1998</option>
      <option>2000</option>
      <option>2001</option>
    </select>

    <p>5. Which metal conducts electricity best?<span style="color:red;"> *</span></p>
    <select id="q4">
      <option value="" selected>Choose an option</option>
      <option>Gold</option>
      <option>Copper</option>
      <option>Silver</option>
      <option>Aluminum</option>
    </select>

    <p>6. Where is Mount Kilimanjaro located?<span style="color:red;"> *</span></p>
    <select id="q5">
      <option value="" selected>Choose an option</option>
      <option>Kenya</option>
      <option>Tanzania</option>
      <option>Ethiopia</option>
      <option>Uganda</option>
    </select>

    <button onclick="startOverplacement()">Next</button>
  </div>

  <!-- ========================= Overplacement Section ========================= -->
  <div class="section hidden" id="overplacementSection">
    <h2>Overplacement</h2>
    <label>Where do you think you rank compared to others in the quiz?<span style="color:red;"> *</span></label>
    <select id="placement">
      <option value="" selected>Choose an option</option>
      <option>Top 10%</option>
      <option>Top 25%</option>
      <option>Average</option>
      <option>Bottom 25%</option>
      <option>Bottom 10%</option>
    </select>
    <button onclick="startOverprecision()">Next</button>
  </div>

  <!-- ========================= Overprecision Section ========================= -->
  <div class="section hidden" id="overprecisionSection">
    <h2>Overprecision</h2>
    <p>With 90% confidence, estimate the following ranges (all fields obbligatori):</p>

    <label>1. Population of France (in millions):<span style="color:red;"> *</span></label>
    <input type="number" id="franceMin" placeholder="Min" /> to <input type="number" id="franceMax" placeholder="Max" />

    <label>2. Year the telephone was invented:<span style="color:red;"> *</span></label>
    <input type="number" id="phoneMin" placeholder="Min" /> to <input type="number" id="phoneMax" placeholder="Max" />

    <label>3. Distance from Rome to Berlin (km):<span style="color:red;"> *</span></label>
    <input type="number" id="romeMin" placeholder="Min" /> to <input type="number" id="romeMax" placeholder="Max" />

    <label>4. Average liters of blood in a human body:<span style="color:red;"> *</span></label>
    <input type="number" id="bloodMin" placeholder="Min" /> to <input type="number" id="bloodMax" placeholder="Max" />

    <label>5. Number of weeks in a year:<span style="color:red;"> *</span></label>
    <input type="number" id="weeksMin" placeholder="Min" /> to <input type="number" id="weeksMax" placeholder="Max" />

    <button onclick="startGame()">Start Beer Game</button>
  </div>

  <!-- ========================= Beer Game Section ========================= -->
  <div class="section hidden" id="gameSection">
    <h2>Beer Game – Distributor Role</h2>
    <table>
      <tr>
        <td><strong>Week:</strong></td>
        <td><span id="week">1</span> / 36</td>
      </tr>
      <tr>
        <td><strong>Wholesaler order:</strong></td>
        <td><span id="demand">4</span></td>
      </tr>
      <tr>
        <td><strong>Inventory:</strong></td>
        <td><span id="inventory">12</span></td>
      </tr>
      <tr>
        <td><strong>Backlog (orders received and not yet processed):</strong></td>
        <td><span id="backlog">0</span></td>
      </tr>
      <tr>
        <td><strong>Last delivery:</strong></td>
        <td><span id="delivery">0</span></td>
      </tr>
      <tr>
        <td><strong>Order to factory:</strong></td>
        <td>
          <input
            type="number"
            id="orderInput"
            min="0"
            value="4"
            style="width: 100px;"
          />
        </td>
      </tr>
    </table>
    <button onclick="nextWeek()">Submit Order</button>
  </div>

  <!-- ========================= Final Results Section ========================= -->
  <div class="section hidden" id="finalResults">
    <h2>Final Results</h2>
    <p id="costOutput"></p>
    <p id="overconfidenceOutput"></p>
    <table>
      <thead>
        <tr>
          <th>Nickname</th>
          <th>Estimated Score</th>
          <th>Quiz Score</th>
          <th>Overconfidence %</th>
          <th>Total Cost</th>
        </tr>
      </thead>
      <tbody id="resultsTable"></tbody>
    </table>
  </div>

  <!-- ========================= SCRIPT ========================= -->
  <script>
    // Variabili globali
    let nickname = "",
      week = 1,
      inventory = 12,
      backlog = 0,
      deliveryQueue = [0, 0],
      orders = [],
      costs = [],
      totalCost = 0;
    let participants = [],
      quizScore = 0;

    // URL del Google Sheet pubblicato come XLSX
    const SHEET_XLSX_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTXgTmxNiE6huxyAb9fsEMYsuyYydv7tQ1i5jIipyYFwm-CZNxYrF5iaW5sOvGVN86vSkDv6c3Ilt_/pub?output=xlsx";

    // Supporto "Enter" nel campo nickname
    document.addEventListener("DOMContentLoaded", function () {
      const nicknameInput = document.getElementById("nickname");
      nicknameInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          startOverestimation();
        }
      });
    });

    // ---------- Funzioni di navigazione tra le sezioni con validazione ----------

    function startOverestimation() {
      nickname = document.getElementById("nickname").value.trim();
      const nickField = document.getElementById("nickname");
      nickField.classList.remove("required-error");

      if (!nickname) {
        alert("Please enter a nickname");
        nickField.classList.add("required-error");
        return;
      }

      if (nickname === "admin") {
        // Chiedo la password
        const pwd = prompt("Enter password:");
        if (pwd === "password") {
          document.getElementById("nicknameSection").classList.add("hidden");
          document.getElementById("adminSection").classList.remove("hidden");
          loadXlsxData();
        } else {
          alert("Wrong password");
        }
        return;
      }

      document.getElementById("nicknameSection").classList.add("hidden");
      document.getElementById("overestimationSection").classList.remove("hidden");
    }

    function startOverplacement() {
      // Rimuovo stili di errore precedenti
      const estimated = document.getElementById("estimatedScore");
      const selects = ["q1","q2","q3","q4","q5"];
      estimated.classList.remove("required-error");
      selects.forEach(id => document.getElementById(id).classList.remove("required-error"));

      let missingFields = [];

      // Controllo estimatedScore
      if (estimated.value.trim() === "" || isNaN(estimated.value) ||
          Number(estimated.value) < 0 || Number(estimated.value) > 5) {
        missingFields.push("Estimated Score (0–5)");
        estimated.classList.add("required-error");
      }

      // Controllo selezioni
      selects.forEach((id, idx) => {
        const sel = document.getElementById(id);
        if (sel.value.trim() === "") {
          missingFields.push(`Question ${idx + 1}`);
          sel.classList.add("required-error");
        }
      });

      if (missingFields.length > 0) {
        alert("Please fill: " + missingFields.join(", "));
        return;
      }

      document.getElementById("overestimationSection").classList.add("hidden");
      document.getElementById("overplacementSection").classList.remove("hidden");
    }

    function startOverprecision() {
      const placement = document.getElementById("placement");
      placement.classList.remove("required-error");

      if (placement.value.trim() === "") {
        alert("Please select your placement");
        placement.classList.add("required-error");
        return;
      }

      document.getElementById("overplacementSection").classList.add("hidden");
      document.getElementById("overprecisionSection").classList.remove("hidden");
    }

    function startGame() {
      // Campi Overprecision
      const fields = [
        { id: "franceMin", name: "France Min" },
        { id: "franceMax", name: "France Max" },
        { id: "phoneMin", name: "Phone Year Min" },
        { id: "phoneMax", name: "Phone Year Max" },
        { id: "romeMin", name: "Rome-Berlin Min" },
        { id: "romeMax", name: "Rome-Berlin Max" },
        { id: "bloodMin", name: "Blood Liters Min" },
        { id: "bloodMax", name: "Blood Liters Max" },
        { id: "weeksMin", name: "Weeks/Year Min" },
        { id: "weeksMax", name: "Weeks/Year Max" }
      ];

      let missingFields = [];
      fields.forEach(f => {
        const inp = document.getElementById(f.id);
        inp.classList.remove("required-error");
        if (inp.value.trim() === "" || isNaN(inp.value)) {
          missingFields.push(f.name);
          inp.classList.add("required-error");
        }
      });

      if (missingFields.length > 0) {
        alert("Please fill: " + missingFields.join(", "));
        return;
      }

      document.getElementById("overprecisionSection").classList.add("hidden");
      document.getElementById("gameSection").classList.remove("hidden");
    }

    // ---------- Logica del Beer Game (per ogni settimana) ----------
    function nextWeek() {
      const demand = week <= 4 ? 4 : 8;
      const order = parseInt(document.getElementById("orderInput").value);
      const delivery = deliveryQueue.shift();
      inventory += delivery;
      let shipped = Math.min(inventory, demand + backlog);
      backlog = Math.max(0, demand + backlog - inventory);
      inventory -= shipped;
      deliveryQueue.push(order);
      const cost = 0.5 * inventory + backlog;
      costs.push(cost);
      totalCost += cost;

      // Aggiorno valori a schermo
      document.getElementById("week").textContent = week + 1;
      document.getElementById("demand").textContent = week < 4 ? 4 : 8;
      document.getElementById("inventory").textContent = inventory;
      document.getElementById("backlog").textContent = backlog;
      document.getElementById("delivery").textContent = delivery;

      if (++week > 36) {
        document.getElementById("gameSection").classList.add("hidden");
        document.getElementById("finalResults").classList.remove("hidden");

        const estimated = parseInt(document.getElementById("estimatedScore").value);
        const answers = ["Canberra", "96", "1998", "Silver", "Tanzania"];
        const userAnswers = ["q1", "q2", "q3", "q4", "q5"].map((id) =>
          document.getElementById(id).value
        );
        quizScore = userAnswers.filter((ans, i) => ans === answers[i]).length;
        const overconfidence = ((estimated - quizScore) / 5 * 100).toFixed(1);

        const data = {
          nickname,
          estimated,
          quizScore,
          overconfidence,
          totalCost,
        };

        // Invio dati su Google Sheets via Apps Script
        fetch(
          "https://script.google.com/macros/s/AKfycbwJU4iJM9LxfrFLxsDcOvYvFDf52_u0xTXCFn_SHJlKCLjGFXv9lC27ld_xjr0SZuqm/exec",
          {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          }
        );

        document.getElementById(
          "costOutput"
        ).textContent = `Total cost incurred: €${totalCost.toFixed(2)}`;
        document.getElementById(
          "overconfidenceOutput"
        ).textContent = `Your overconfidence score: ${overconfidence}%`;

        const row = document.createElement("tr");
        row.innerHTML = `<td>${nickname}</td><td>${estimated}</td><td>${quizScore}</td><td>${overconfidence}%</td><td>€${totalCost.toFixed(
          2
        )}</td>`;
        document.getElementById("resultsTable").appendChild(row);
      }
    }

    // ---------- Caricamento dati dall’XLSX pubblicato ----------
    function loadXlsxData() {
      const tbody = document.getElementById("adminTable");
      tbody.innerHTML = "";

      fetch(SHEET_XLSX_URL)
        .then((response) => {
          if (!response.ok) throw new Error("Errore caricamento XLSX");
          return response.arrayBuffer();
        })
        .then((arrayBuffer) => {
          // Lettura del workbook
          const data = new Uint8Array(arrayBuffer);
          const workbook = XLSX.read(data, { type: "array" });
          // Prendo il primo foglio
          const firstSheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheetName];
          // Converto in array di array (comprese intestazioni)
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          // Se ci sono meno di 2 righe (solo intestazioni), mostro “No data”
          if (rows.length < 2) {
            const rigaVuota = document.createElement("tr");
            rigaVuota.innerHTML = `<td colspan="5">No data</td>`;
            tbody.appendChild(rigaVuota);
            return;
          }

          // Rigiro ogni riga partendo da i=1 (salto intestazioni)
          for (let i = 1; i < rows.length; i++) {
            const cols = rows[i];
            // Se la prima cella (nickname) è assente/ vuota, salto
            if (!cols[0]) continue;

            const riga = document.createElement("tr");
            riga.innerHTML = `
              <td>${cols[0]}</td>
              <td>${cols[1] !== undefined ? cols[1] : ""}</td>
              <td>${cols[2] !== undefined ? cols[2] : ""}</td>
              <td>${cols[3] !== undefined ? cols[3] + "%" : ""}</td>
              <td>${cols[4] !== undefined ? "€" + parseFloat(cols[4]).toFixed(2) : ""}</td>
            `;
            tbody.appendChild(riga);
          }
        })
        .catch((err) => {
          console.error("Errore lettura XLSX:", err);
          const rigaErrore = document.createElement("tr");
          rigaErrore.innerHTML = `<td colspan="5">Non è stato possibile caricare i dati dal Google Sheet</td>`;
          tbody.appendChild(rigaErrore);
        });
    }

    // ---------- Download diretto dell’XLSX ----------
    function downloadSheet() {
      window.open(SHEET_XLSX_URL, "_blank");
    }
  </script>
</body>
</html>
