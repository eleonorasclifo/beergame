<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n-key="title">Overconfidence & Beer Game</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 20px; position: relative; }
    .hidden { display: none; }
    .section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    /* Solo per demographics: etichette e campi uno sotto l’altro */
    .section#demographicsSection label,
    .section#demographicsSection input,
    .section#demographicsSection select {
      display: block;
      width: 100%;
      margin: 8px 0 16px;
    }
    h1 { color: #2c3e50; margin: 0 0 15px; font-size: 24px; }
    h2 { color: #2c3e50; margin-bottom: 15px; }
    p, label { margin: 10px 0 5px; font-size: 14px; line-height: 1.5; }
    input, select, button { padding: 8px; font-size: 14px; }
    button { background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #2980b9; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .required-error { border: 2px solid red !important; }
    .overprecision-row { display: flex; align-items: center; margin-bottom: 12px; }
    .overprecision-row label { flex: 0 0 300px; margin: 0; font-weight: 500; font-size: 14px; }
    .overprecision-row .inputs-container { display: flex; gap: 10px; flex: 1; }
    .overprecision-row .inputs-container input { width: 100px; }
    .progress-wrapper { margin: 20px 0; }
    .progress-bar { position: relative; background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden; }
    .progress-fill { height: 100%; width: 0; background: #3498db; border-radius: 10px 0 0 10px; transition: width 0.3s ease; }
    .progress-label { text-align: center; margin-top: 5px; font-weight: bold; font-size: 14px; }
    #langSwitcher { position: fixed; top: 10px; right: 20px; font-size: 14px; }
    #langSwitcher button {
      background: none; border: 1px solid #3498db; color: #3498db;
      padding: 4px 10px; border-radius: 4px; font-weight: bold;
      transition: background 0.2s, color 0.2s; margin-left: 5px; cursor: pointer;
    }
    #langSwitcher button.selected { background: #3498db; color: white; }
  </style>
  <script src="https://cdn.sheetjs.com/xlsx-0.18.7/package/dist/xlsx.full.min.js"></script>
</head>
<body>

  <!-- Language switcher -->
  <div id="langSwitcher">
    <button id="btn-en" class="selected">EN</button> |
    <button id="btn-it">IT</button>
  </div>

  <!-- Welcome & Nickname -->
  <div class="section" id="nicknameSection">
    <h1 data-i18n-key="welcomeTitle">Benvenuto</h1>
    <p data-i18n-key="welcomeText1">
      Vuoi scoprire quanto sia il tuo livello di overconfidence? Lo scoprirai con questo test!
    </p>
    <p data-i18n-key="welcomeText2">
      È composto da due parti: nella prima ti sarà sottoposto un questionario, nella seconda dovrai giocare al gioco del BeerGame (per il quale le istruzioni ti verranno date successivamente). La cosa importante è non utilizzare strumenti di supporto (google, chatgpt ecc..) per rispondere alle domande, perché andrebbe a falsare i risultati del test. Ti chiedo, pertanto, di essere quanto più spontaneo possibile nelle risposte date.
    </p>
    <p data-i18n-key="welcomeText3">Grazie!</p>

    <h2 data-i18n-key="enterNicknameTitle">Enter your nickname</h2>
    <input type="text" id="nickname" placeholder="Nickname" />
    <button data-i18n-key="btnStart" onclick="startOverestimation()">Start</button>
  </div>

  <!-- Demographics -->
  <div class="section hidden" id="demographicsSection">
    <h2 data-i18n-key="demographicsTitle">Your demographic info</h2>

    <label data-i18n-key="labelGender">Gender <span style="color:red;">*</span></label>
    <select id="gender">
      <option value="" selected data-i18n-key="optChoose">Choose an option</option>
      <option data-i18n-key="optMale">Male</option>
      <option data-i18n-key="optFemale">Female</option>
      <option data-i18n-key="optOther">Other</option>
      <option data-i18n-key="optNoSay">Prefer not to say</option>
    </select>

    <label data-i18n-key="labelAge">Age <span style="color:red;">*</span></label>
    <input type="number" id="age" min="10" max="120" placeholder="e.g. 30" />

    <label data-i18n-key="labelEdu">Education level <span style="color:red;">*</span></label>
    <select id="education">
      <option value="" selected data-i18n-key="optChoose">Choose an option</option>
      <option data-i18n-key="optHighSchool">High School</option>
      <option data-i18n-key="optBachelors">Bachelor’s</option>
      <option data-i18n-key="optMasters">Master’s</option>
      <option data-i18n-key="optPhD">PhD</option>
      <option data-i18n-key="optOther">Other</option>
    </select>

    <label data-i18n-key="labelNationality">Nationality <span style="color:red;">*</span></label>
    <input type="text" id="nationality" placeholder="e.g. Italian" />

    <label data-i18n-key="labelSupplyChainConf">Confidenza con la supply chain <span style="color:red;">*</span></label>
    <select id="supplyChainConf">
      <option value="" selected data-i18n-key="optChoose">Choose an option</option>
      <option value="yes" data-i18n-key="optYes">Yes</option>
      <option value="no" data-i18n-key="optNo">No</option>
    </select>

    <button data-i18n-key="btnNext" onclick="startDemographics()">Next</button>
  </div>

  <!-- Admin Panel -->
  <div class="section hidden" id="adminSection">
    <h2 data-i18n-key="adminPanelTitle">Admin Panel</h2>
    <button data-i18n-key="btnDownload" onclick="downloadSheet()">Download Google Sheet XLSX</button>
    <table>
      <thead>
        <tr>
          <th data-i18n-key="thNickname">Nickname</th>
          <th data-i18n-key="thOverest">Overestimation %</th>
          <th data-i18n-key="thOverplac">Overplacement %</th>
          <th data-i18n-key="thOverprec">Overprecision %</th>
          <th data-i18n-key="thOCI">OCI %</th>
          <th data-i18n-key="thTotalCost">Total Cost</th>
        </tr>
      </thead>
      <tbody id="adminTable"></tbody>
    </table>
  </div>

  <!-- Overestimation -->
  <div class="section hidden" id="overestimationSection">
    <h2 data-i18n-key="overestimationCalcTitle">Overestimation Calculation</h2>
    <p data-i18n-key="qEst1">1. What is the capital of Australia? <span style="color:red;">*</span></p>
    <select id="q1">
      <option value="" selected data-i18n-key="optChoose">Choose an option</option>
      <option>Sydney</option>
      <option>Canberra</option>
      <option>Melbourne</option>
      <option>Brisbane</option>
    </select>
    <p data-i18n-key="qEst2">2. What is 12 × 8? <span style="color:red;">*</span></p>
    <select id="q2">
      <option value="" selected data-i18n-key="optChoose">Choose an option</option>
      <option>80</option>
      <option>96</option>
      <option>108</option>
      <option>92</option>
    </select>
    <p data-i18n-key="qEst3">3. In what year was Google founded? <span style="color:red;">*</span></p>
    <select id="q3">
      <option value="" selected data-i18n-key="optChoose">Choose an option</option>
      <option>1996</option>
      <option>1998</option>
      <option>2000</option>
      <option>2001</option>
    </select>
    <p data-i18n-key="qEst4">4. Which metal conducts electricity best? <span style="color:red;">*</span></p>
    <select id="q4">
      <option value="" selected data-i18n-key="optChoose">Choose an option</option>
      <option>Gold</option>
      <option>Copper</option>
      <option>Silver</option>
      <option>Aluminum</option>
    </select>
    <p data-i18n-key="qEst5">5. Where is Mount Kilimanjaro located? <span style="color:red;">*</span></p>
    <select id="q5">
      <option value="" selected data-i18n-key="optChoose">Choose an option</option>
      <option>Kenya</option>
      <option>Tanzania</option>
      <option>Ethiopia</option>
      <option>Uganda</option>
    </select>
    <p data-i18n-key="qEst6">6. How many answers do you think you got right out of 5? <span style="color:red;">*</span></p>
    <input type="number" id="estimatedScore" min="0" max="5" placeholder="0–5" />
    <button data-i18n-key="btnNext" onclick="startOverplacement()">Next</button>
  </div>

  <!-- Overplacement -->
  <div class="section hidden" id="overplacementSection">
    <h2 data-i18n-key="overplacementTitle">Overplacement</h2>
    <label data-i18n-key="qPlacement1">Where do you think you rank compared to others in the quiz? <span style="color:red;">*</span></label>
    <select id="placement">
      <option value="" selected data-i18n-key="optChoose">Choose an option</option>
      <option>Top 10%</option>
      <option>Top 25%</option>
      <option>Average</option>
      <option>Bottom 25%</option>
      <option>Bottom 10%</option>
    </select>
    <button data-i18n-key="btnNext" onclick="startOverprecision()">Next</button>
  </div>

  <!-- Overprecision -->
  <div class="section hidden" id="overprecisionSection">
    <h2 data-i18n-key="overprecisionTitle">Overprecision</h2>
    <p data-i18n-key="overprecisionInstr">With 90% confidence, estimate the following ranges (all fields required):</p>
    <div class="overprecision-row">
      <label for="phoneMin" data-i18n-key="qPrec1">1. Year the telephone was invented: <span style="color:red;">*</span></label>
      <div class="inputs-container">
        <input type="number" id="phoneMin" placeholder="Min" />
        <input type="number" id="phoneMax" placeholder="Max" />
      </div>
    </div>
    <div class="overprecision-row">
      <label for="romeMin" data-i18n-key="qPrec2">2. Distance from Rome to Berlin (km): <span style="color:red;">*</span></label>
      <div class="inputs-container">
        <input type="number" id="romeMin" placeholder="Min" />
        <input type="number" id="romeMax" placeholder="Max" />
      </div>
    </div>
    <div class="overprecision-row">
      <label for="bloodMin" data-i18n-key="qPrec3">3. Average liters of blood in a human body: <span style="color:red;">*</span></label>
      <div class="inputs-container">
        <input type="number" id="bloodMin" placeholder="Min" />
        <input type="number" id="bloodMax" placeholder="Max" />
      </div>
    </div>
    <div class="overprecision-row">
      <label for="weeksMin" data-i18n-key="qPrec4">4. Number of weeks in a year: <span style="color:red;">*</span></label>
      <div class="inputs-container">
        <input type="number" id="weeksMin" placeholder="Min" />
        <input type="number" id="weeksMax" placeholder="Max" />
      </div>
    </div>
    <div class="overprecision-row">
      <label for="moonMin" data-i18n-key="qPrec5">5. In what year did the first Moon landing occur? <span style="color:red;">*</span></label>
      <div class="inputs-container">
        <input type="number" id="moonMin" placeholder="Min" />
        <input type="number" id="moonMax" placeholder="Max" />
      </div>
    </div>
    <div class="overprecision-row">
      <label for="poolMin" data-i18n-key="qPrec6">6. How many liters of water does an Olympic pool contain? <span style="color:red;">*</span></label>
      <div class="inputs-container">
        <input type="number" id="poolMin" placeholder="Min" />
        <input type="number" id="poolMax" placeholder="Max" />
      </div>
    </div>
    <div class="overprecision-row">
      <label for="radiusMin" data-i18n-key="qPrec7">7. What is the Earth's average radius (km)? <span style="color:red;">*</span></label>
      <div class="inputs-container">
        <input type="number" id="radiusMin" placeholder="Min" />
        <input type="number" id="radiusMax" placeholder="Max" />
      </div>
    </div>
    <div class="overprecision-row">
      <label for="wallMin" data-i18n-key="qPrec8">8. In what year did the Berlin Wall fall? <span style="color:red;">*</span></label>
      <div class="inputs-container">
        <input type="number" id="wallMin" placeholder="Min" />
        <input type="number" id="wallMax" placeholder="Max" />
      </div>
    </div>
    <div class="overprecision-row">
      <label for="secondsMin" data-i18n-key="qPrec9">9. How many seconds are there in a day? <span style="color:red;">*</span></label>
      <div class="inputs-container">
        <input type="number" id="secondsMin" placeholder="Min" />
        <input type="number" id="secondsMax" placeholder="Max" />
      </div>
    </div>
    <div class="overprecision-row">
      <label for="franceMin" data-i18n-key="qPrec10">10. Population of France (in millions): <span style="color:red;">*</span></label>
      <div class="inputs-container">
        <input type="number" id="franceMin" placeholder="Min" />
        <input type="number" id="franceMax" placeholder="Max" />
      </div>
    </div>
    <button data-i18n-key="btnStartSim" onclick="showRules()">Start Beer Game</button>
  </div>

  <!-- Rules -->
  <div class="section hidden" id="rulesSection">
    <h2 data-i18n-key="rulesTitle">Simulation Rules</h2>
    <p data-i18n-key="rulesDesc1">
      In this game you play the Distributor, the role linking the Factory to the Wholesaler in the beer distribution chain.
    </p>
    <p data-i18n-key="rulesAttention">ATTENTION:</p>
    <ul>
      <li data-i18n-key="rulesBullet1">
        You receive an order from the Wholesaler, your direct customer. The order represents the number of cases the Wholesaler requires to meet final customer demand.
      </li>
      <li data-i18n-key="rulesBullet2">
        Demand can vary at any time, but you do not know the final demand or when it will change: you can only observe the trend of orders you receive week after week to understand whether demand is rising or falling.
      </li>
      <li data-i18n-key="rulesBullet3">
        You must ship the cases to the Wholesaler to satisfy their order. If you do not have enough cases in inventory, unfulfilled orders are recorded as backlog, i.e., delayed orders that incur costs until you deliver them.
      </li>
      <li data-i18n-key="rulesBullet4">
        Every week, you decide how many cases to order from the Factory, your supplier. Orders you place with the Factory will reach you after a lead time of 2 weeks: what you order today will be delivered only after two weeks.
      </li>
      <li data-i18n-key="rulesBullet5">
        Your shipments to the Wholesaler also have a lead time of 2 weeks: the cases you ship today will arrive at the Wholesaler after 2 weeks.
      </li>
      <li data-i18n-key="rulesBullet6">
        You must manage your inventory to avoid both stockouts (which generate backlog and delay costs) and excessive stock accumulation (which generates holding costs).
      </li>
    </ul>
    <p data-i18n-key="rulesDesc2">
      The game shows each week your current inventory, the accumulated backlog, and the order you received: use this information to plan the quantities to order from the Factory.
    </p>
    <button data-i18n-key="btnBeginSim" onclick="beginGame()">Begin Simulation</button>
  </div>

  <!-- Beer Game -->
  <div class="section hidden" id="gameSection">
    <h2 data-i18n-key="gameTitle">Beer Game – Distributor Role</h2>
    <div class="progress-wrapper">
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressLabel" class="progress-label">Week: 1 / 50</div>
    </div>
    <table>
      <tr><td><strong data-i18n-key="labelWholesalerOrder">Wholesaler order:</strong></td><td><span id="demand">4</span></td></tr>
      <tr><td><strong data-i18n-key="labelInventory">Inventory:</strong></td><td><span id="inventory">12</span></td></tr>
      <tr><td><strong data-i18n-key="labelBacklog">Backlog (orders received and not yet processed):</strong></td><td><span id="backlog">0</span></td></tr>
      <tr><td><strong data-i18n-key="labelLastDelivery">Last delivery:</strong></td><td><span id="delivery">0</span></td></tr>
      <tr><td><strong data-i18n-key="labelOrderToFactory">Order to factory:</strong></td><td><input type="number" id="orderInput" min="0" value="4" style="width:100px;"/></td></tr>
    </table>
    <button data-i18n-key="btnSubmitOrder" onclick="nextWeek()">Submit Order</button>
  </div>

  <!-- Final Results -->
  <div class="section hidden" id="finalResults">
    <h2 data-i18n-key="finalResultsTitle">Final Results</h2>
    <p id="thankYou" data-i18n-key="thankYou"></p>
    <table>
      <thead>
        <tr>
          <th data-i18n-key="thNickname">Nickname</th>
          <th data-i18n-key="thOverest">Overestimation level</th>
          <th data-i18n-key="thOverprec">Overprecision level</th>
          <th data-i18n-key="thTotalCost">Total Cost Beer Game</th>
        </tr>
      </thead>
      <tbody id="resultsTable"></tbody>
    </table>
  </div>

  <script>
    const translations = {
      en: {
        title: "Overconfidence & Beer Game",
        welcomeTitle: "Welcome",
        welcomeText1: "Do you want to discover your level of overconfidence? You'll find out with this test!",
        welcomeText2: "It consists of two parts: in the first you will be given a questionnaire, in the second you will play the BeerGame (for which you'll receive instructions later). It's important not to use support tools (Google, ChatGPT, etc.) to answer the questions, as it would skew the results. Please be as spontaneous as possible in your responses.",
        welcomeText3: "Thank you!",
        enterNicknameTitle: "Enter your nickname",
        btnStart: "Start",
        demographicsTitle: "Your demographic info",
        labelGender: "Gender",
        labelAge: "Age",
        labelEdu: "Education level",
        labelNationality: "Nationality",
        labelSupplyChainConf: "Confidence with supply chain",
        optChoose: "Choose an option",
        optMale: "Male",
        optFemale: "Female",
        optOther: "Other",
        optNoSay: "Prefer not to say",
        optHighSchool: "High School",
        optBachelors: "Bachelor’s",
        optMasters: "Master’s",
        optPhD: "PhD",
        optOther: "Other",
        optYes: "Yes",
        optNo: "No",
        btnNext: "Next",
        adminPanelTitle: "Admin Panel",
        btnDownload: "Download Google Sheet XLSX",
        thNickname: "Nickname",
        thOverest: "Overestimation %",
        thOverplac: "Overplacement %",
        thOverprec: "Overprecision %",
        thOCI: "OCI %",
        thTotalCost: "Total Cost",
        overestimationCalcTitle: "Overestimation Calculation",
        qEst1: "1. What is the capital of Australia? <span style=\"color:red;\">*</span>",
        qEst2: "2. What is 12 × 8? <span style=\"color:red;\">*</span>",
        qEst3: "3. In what year was Google founded? <span style=\"color:red;\">*</span>",
        qEst4: "4. Which metal conducts electricity best? <span style=\"color:red;\">*</span>",
        qEst5: "5. Where is Mount Kilimanjaro located? <span style=\"color:red;\">*</span>",
        qEst6: "How many answers do you think you got right out of 5? <span style=\"color:red;\">*</span>",
        overplacementTitle: "Overplacement",
        qPlacement1: "Where do you think you rank compared to others in the quiz? <span style=\"color:red;\">*</span>",
        overprecisionTitle: "Overprecision",
        overprecisionInstr: "With 90% confidence, estimate the following ranges (all fields required):",
        qPrec1: "1. Year the telephone was invented: <span style=\"color:red;\">*</span>",
        qPrec2: "2. Distance from Rome to Berlin (km): <span style=\"color:red;\">*</span>",
        qPrec3: "3. Average liters of blood in a human body: <span style=\"color:red;\">*</span>",
        qPrec4: "4. Number of weeks in a year: <span style=\"color:red;\">*</span>",
        qPrec5: "5. In what year did the first Moon landing occur? <span style=\"color:red;\">*</span>",
        qPrec6: "6. How many liters of water does an Olympic pool contain? <span style=\"color:red;\">*</span>",
        qPrec7: "7. What is the Earth's average radius (km)? <span style=\"color:red;\">*</span>",
        qPrec8: "8. In what year did the Berlin Wall fall? <span style=\"color:red;\">*</span>",
        qPrec9: "9. How many seconds are there in a day? <span style=\"color:red;\">*</span>",
        qPrec10:"10. Population of France (in millions): <span style=\"color:red;\">*</span>",
        btnStartSim: "Start Beer Game",
        rulesTitle: "Simulation Rules",
        rulesDesc1: "In this game you play the Distributor, the role linking the Factory to the Wholesaler in the beer distribution chain.",
        rulesAttention: "ATTENTION:",
        rulesBullet1: "You receive an order from the Wholesaler, your direct customer. The order represents the number of cases the Wholesaler requires to meet final customer demand.",
        rulesBullet2: "Demand can vary at any time, but you do not know the final demand or when it will change: you can only observe the trend of orders you receive week after week to understand whether demand is rising or falling.",
        rulesBullet3: "You must ship the cases to the Wholesaler to satisfy their order. If you do not have enough cases in inventory, unfulfilled orders are recorded as backlog, i.e., delayed orders that incur costs until you deliver them.",
        rulesBullet4: "Every week, you decide how many cases to order from the Factory, your supplier. Orders you place with the Factory will reach you after a lead time of 2 weeks: what you order today will be delivered only after two weeks.",
        rulesBullet5: "Your shipments to the Wholesaler also have a lead time of 2 weeks: the cases you ship today will arrive at the Wholesaler after 2 weeks.",
        rulesBullet6: "You must manage your inventory to avoid both stockouts (which generate backlog and delay costs) and excessive stock accumulation (which generates holding costs).",
        rulesDesc2: "The game shows each week your current inventory, the accumulated backlog, and the order you received: use this information to plan the quantities to order from the Factory.",
        clickSubmitOrder: "Submit Order",
        btnBeginSim: "Begin Simulation",
        gameTitle: "Beer Game – Distributor Role",
        labelWholesalerOrder: "Wholesaler order:",
        labelInventory: "Inventory:",
        labelBacklog: "Backlog (orders received and not yet processed):",
        labelLastDelivery: "Last delivery:",
        labelOrderToFactory: "Order to factory:",
        btnSubmitOrder: "Submit Order",
        finalResultsTitle: "Final Results",
        thankYou: "Thank you for playing!",
        labelYourNick: "Your nickname is: ",
        labelYourCode: "Your unique code is: "
      },
      it: {
        title: "Overconfidence & Beer Game",
        welcomeTitle: "Benvenuto",
        welcomeText1: "Vuoi scoprire quanto sia il tuo livello di overconfidence? Lo scoprirai con questo test!",
        welcomeText2: "È composto da due parti: nella prima ti sarà sottoposto un questionario, nella seconda dovrai giocare al gioco del BeerGame (per il quale le istruzioni ti verranno date successivamente). La cosa importante è non utilizzare strumenti di supporto (google, chatgpt ecc..) per rispondere alle domande, perché andrebbe a falsare i risultati del test. Ti chiedo, pertanto, di essere quanto più spontaneo possibile nelle risposte date.",
        welcomeText3: "Grazie!",
        enterNicknameTitle: "Inserisci il tuo nickname",
        btnStart: "Avvia",
        demographicsTitle: "I tuoi dati anagrafici",
        labelGender: "Sesso",
        labelAge: "Età",
        labelEdu: "Livello di istruzione",
        labelNationality: "Nazionalità",
        labelSupplyChainConf: "Confidenza con la supply chain",
        optChoose: "Scegli un’opzione",
        optMale: "Maschile",
        optFemale: "Femminile",
        optOther: "Altro",
        optNoSay: "Preferisco non dirlo",
        optHighSchool: "Scuola Superiore",
        optBachelors: "Laurea Triennale",
        optMasters: "Laurea Magistrale",
        optPhD: "Dottorato",
        optOther: "Altro",
        optYes: "Sì",
        optNo: "No",
        btnNext: "Avanti",
        adminPanelTitle: "Pannello Admin",
        btnDownload: "Scarica Google Sheet XLSX",
        thNickname: "Nickname",
        thOverest: "Overestimation %",
        thOverplac: "Overplacement %",
        thOverprec: "Overprecision %",
        thOCI: "OCI %",
        thTotalCost: "Costo Totale",
        overestimationCalcTitle: "Calcolo Overestimation",
        qEst1: "1. Qual è la capitale dell’Australia? <span style=\"color:red;\">*</span>",
        qEst2: "2. Quanto fa 12 × 8? <span style=\"color:red;\">*</span>",
        qEst3: "3. In che anno è stata fondata Google? <span style=\"color:red;\">*</span>",
        qEst4: "4. Quale metallo conduce meglio l’elettricità? <span style=\"color:red;\">*</span>",
        qEst5: "5. Dove si trova il Monte Kilimanjaro? <span style=\"color:red;\">*</span>",
        qEst6: "Quante risposte pensi di aver indovinato su 5? <span style=\"color:red;\">*</span>",
        overplacementTitle: "Overplacement",
        qPlacement1: "Dove pensi di posizionarti rispetto agli altri nel quiz? <span style=\"color:red;\">*</span>",
        overprecisionTitle: "Overprecision",
        overprecisionInstr: "Con 90% di confidenza, stima i seguenti intervalli (tutti i campi obbligatori):",
        qPrec1: "1. Anno in cui è stato inventato il telefono: <span style=\"color:red;\">*</span>",
        qPrec2: "2. Distanza da Roma a Berlino (km): <span style=\"color:red;\">*</span>",
        qPrec3: "3. Litri di sangue medi in un corpo umano: <span style=\"color:red;\">*</span>",
        qPrec4: "4. Numero di settimane in un anno: <span style=\"color:red;\">*</span>",
        qPrec5: "5. In che anno è avvenuto il primo sbarco sulla Luna? <span style=\"color:red;\">*</span>",
        qPrec6: "6. Quanti litri d'acqua contiene una piscina olimpionica? <span style=\"color:red;\">*</span>",
        qPrec7: "7. Quanti chilometri misura il raggio terrestre medio? <span style=\"color:red;\">*</span>",
        qPrec8: "8. In che anno è caduto il Muro di Berlino? <span style=\"color:red;\">*</span>",
        qPrec9: "9. Quanti secondi ci sono in un giorno? <span style=\"color:red;\">*</span>",
        qPrec10:"10. Popolazione della Francia (in milioni): <span style=\"color:red;\">*</span>",
        btnStartSim: "Inizia Beer Game",
        rulesTitle: "Regole della Simulazione",
        rulesDesc1: "In questo gioco interpreti il Distributor, il ruolo che collega la Factory al Wh wholesaler nella catena di distribuzione della birra.",
        rulesAttention: "ATTENZIONE:",
        rulesBullet1: "Ricevi un ordine dal Wh wholesaler, il tuo cliente diretto. L’ordine rappresenta la quantità di casse che il Wh wholesaler richiede per soddisfare la domanda del cliente finale.",
        rulesBullet2: "La domanda può variare in qualsiasi momento, ma non conosci né la domanda finale né quando cambierà: puoi solo osservare l’andamento degli ordini che ricevi settimana dopo settimana per capire se la domanda sta salendo o scendendo.",
        rulesBullet3: "Devi spedire le casse al Wh wholesaler per soddisfare il suo ordine. Se non hai abbastanza casse in magazzino, gli ordini non evasi vengono registrati come backlog, cioè ordini arretrati che accumulano costi finché non li consegni.",
        rulesBullet4: "Ogni settimana, decidi quante casse ordinare alla Factory, il tuo fornitore. Gli ordini che fai alla Factory arriveranno a te dopo un lead time di 2 settimane: quello che ordini oggi ti verrà consegnato solo dopo due settimane.",
        rulesBullet5: "Anche le tue spedizioni al Wh wholesaler hanno un lead time di 2 settimane: le casse che spedisci oggi arriveranno al Wh wholesaler dopo 2 settimane.",
        rulesBullet6: "Devi gestire il tuo magazzino in modo da evitare sia mancanze di prodotto (che generano backlog e costi di ritardo) sia accumuli di scorte eccessive (che generano costi di magazzino).",
        rulesDesc2: "Il gioco mostra ogni settimana il tuo inventario attuale, il backlog accumulato e l’ordine che hai ricevuto: usa queste informazioni per pianificare le quantità da ordinare alla Factory.",
        btnBeginSim: "Inizia Simulazione",
        clickSubmitOrder: "Invia Ordine",
        gameTitle: "Beer Game – Ruolo Distributore",
        labelWholesalerOrder: "Ordine dal Grossista:",
        labelInventory: "Inventario:",
        labelBacklog: "Backlog (ordini ricevuti e non ancora evasi):",
        labelLastDelivery: "Ultima consegna:",
        labelOrderToFactory: "Ordine alla fabbrica:",
        btnSubmitOrder: "Invia Ordine",
        finalResultsTitle: "Risultati Finali",
        thankYou: "Grazie per aver giocato!",
        labelYourNick: "Il tuo nickname è: ",
        labelYourCode: "Il tuo codice univoco è: "
      }
    };

    let currentLang = "en";
    function applyTranslations() {
      document.querySelectorAll("[data-i18n-key]").forEach(el => {
        const key = el.getAttribute("data-i18n-key");
        if (translations[currentLang][key] !== undefined) {
          el.innerHTML = translations[currentLang][key];
        }
      });
    }

    function confidenceLabel(value) {
      if (value > 0)  return "OVERCONFIDENT";
      if (value < 0)  return "UNDERCONFIDENT";
      return "RIGHT LEVEL OF CONFIDENCE";
    } 

    document.getElementById("btn-en").addEventListener("click", () => {
      currentLang = "en";
      document.getElementById("btn-en").classList.add("selected");
      document.getElementById("btn-it").classList.remove("selected");
      applyTranslations();
    });
    document.getElementById("btn-it").addEventListener("click", () => {
      currentLang = "it";
      document.getElementById("btn-it").classList.add("selected");
      document.getElementById("btn-en").classList.remove("selected");
      applyTranslations();
    });
    applyTranslations();

    // Helpers
    function el(id){ return document.getElementById(id); }
    function hide(id){ el(id).classList.add("hidden"); }
    function show(id){ el(id).classList.remove("hidden"); }

    // Globals & Constants
    const TRUE_VALUES = {
      france: 67.5,
      phone: 1876,
      rome: 1181,
      blood: 5,
      weeks: 52,
      moon: 1969,
      pool: 2500000,
      radius: 6371,
      wall: 1989,
      seconds: 86400
    };
    const SHEET_XLSX_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTXgTmxNiE6huxyAb9fsEMYsuyYydv7q1i5jIipyYFwm-CZNxYrF5iaW5sOvGVN86vSkDv6c3Ilt_/pub?output=xlsx";

    let nickname = "",
        userCode = "",
        gender = "",
        age = null,
        education = "",
        nationality = "",
        supplyChainConf = "",
        week = 1,
        inventory = 8,
        backlog = 0,
        deliveryQueue = [0, 0],
        costs = [],
        totalCost = 0.5 * inventory,
        orders = [];

    function generateCode6() {
      let code = "";
      for (let i = 0; i < 6; i++) code += Math.floor(Math.random() * 10);
      return code;
    }

    function startOverestimation() {
      const nickField = el("nickname");
      nickname = nickField.value.trim();
      nickField.classList.remove("required-error");
      if (!nickname) {
        alert(currentLang==="it"
          ? "Per favore inserisci un nickname"
          : "Please enter a nickname");
        nickField.classList.add("required-error");
        return;
      }
      userCode = generateCode6();
      fetch(
        "https://script.google.com/macros/s/AKfycbwJU4iJM9LxfrFLxsDcOvYvFDf52_u0xTXCFn_SHJlKCLjGFXv9lC27ld_xjr0SZuqm/exec",
        { method:"POST", mode:"no-cors",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ nickname, code: userCode })
        }
      ).catch(()=>{});
      hide("nicknameSection");
      show("demographicsSection");
    }

    function startDemographics() {
      const g = el("gender"),
            a = el("age"),
            e = el("education"),
            n = el("nationality"),
            sc = el("supplyChainConf");
      [g,a,e,n,sc].forEach(x=>x.classList.remove("required-error"));
      let miss = false;
      if (!g.value)           { miss = true; g.classList.add("required-error"); }
      if (!a.value||isNaN(a.value)) { miss = true; a.classList.add("required-error"); }
      if (!e.value)           { miss = true; e.classList.add("required-error"); }
      if (!n.value.trim())    { miss = true; n.classList.add("required-error"); }
      if (!sc.value)          { miss = true; sc.classList.add("required-error"); }
      if (miss) {
        alert(currentLang==="it"
          ? "Per favore compila tutti i campi anagrafici"
          : "Please fill all demographic fields");
        return;
      }
      gender = g.value;
      age = Number(a.value);
      education = e.value;
      nationality = n.value.trim();
      supplyChainConf = sc.value;
      hide("demographicsSection");
      show("overestimationSection");
    }

function startOverplacement() {
  // rimuovi eventuali errori preesistenti
  const fields = [
    el("q1"), el("q2"), el("q3"),
    el("q4"), el("q5"), el("estimatedScore")
  ];
  fields.forEach(f => f.classList.remove("required-error"));

  // controlla se qualcuno è mancante o non valido
  let miss = false;

  // le prime 5 sono select, devono avere value
  ["q1","q2","q3","q4","q5"].forEach(id => {
    const sel = el(id);
    if (!sel.value) {
      sel.classList.add("required-error");
      miss = true;
    }
  });

  // ultimo campo: numero da 0 a 5
  const est = el("estimatedScore");
  const v = est.value.trim();
  if (v === "" || isNaN(v) || Number(v) < 0 || Number(v) > 5) {
    est.classList.add("required-error");
    miss = true;
  }

  if (miss) {
    alert(
      currentLang === "it"
        ? "Per favore compila tutti i campi per procedere"
        : "Please fill all fields to proceed"
    );
    return;
  }

  // se tutto ok, vai avanti
  hide("overestimationSection");
  show("overplacementSection");
}

    function startOverprecision() {
      const pl = el("placement");
      pl.classList.remove("required-error");
      if (!pl.value.trim()) {
        alert(currentLang==="it"
          ? "Per favore compila tutti i campi per procedere"
          : "Please fill all fields to proceed");
        pl.classList.add("required-error");
        return;
      }
      hide("overplacementSection");
      show("overprecisionSection");
    }

    function showRules() {
      const fields = [
        {min: el("phoneMin"),   max: el("phoneMax")},
        {min: el("romeMin"),    max: el("romeMax")},
        {min: el("bloodMin"),   max: el("bloodMax")},
        {min: el("weeksMin"),   max: el("weeksMax")},
        {min: el("moonMin"),    max: el("moonMax")},
        {min: el("poolMin"),    max: el("poolMax")},
        {min: el("radiusMin"),  max: el("radiusMax")},
        {min: el("wallMin"),    max: el("wallMax")},
        {min: el("secondsMin"), max: el("secondsMax")},
        {min: el("franceMin"),  max: el("franceMax")}
      ];
      let invalid = false;
      fields.forEach(pair => {
        pair.min.classList.remove("required-error");
        pair.max.classList.remove("required-error");
        const minV = parseFloat(pair.min.value),
              maxV = parseFloat(pair.max.value);
        if (isNaN(minV) || isNaN(maxV) || maxV < minV) {
          invalid = true;
          pair.min.classList.add("required-error");
          pair.max.classList.add("required-error");
        }
      });
      if (invalid) {
        alert(currentLang==="it"
          ? "Per favore compila tutti i campi con valori numerici validi e assicurati che Max ≥ Min"
          : "Please fill all fields with valid numbers and ensure Max ≥ Min");
        return;
      }
      hide("overprecisionSection");
      show("rulesSection");
    }

    function beginGame() {
      hide("rulesSection");
      show("gameSection");
      updateProgressBar();
    }

    function nextWeek() {
      const demand = week <= 4 ? 4 : 8;
      const order = parseInt(el("orderInput").value);
      orders.push(order);
      const delivery = deliveryQueue.shift();
      inventory += delivery;
      const shipped = Math.min(inventory, demand + backlog);
      backlog = Math.max(0, demand + backlog - inventory);
      inventory -= shipped;
      deliveryQueue.push(order);
      const cost = 0.5 * inventory + backlog;
      costs.push(cost);
      totalCost += cost;
      el("demand").textContent = demand;
      el("inventory").textContent = inventory;
      el("backlog").textContent = backlog;
      el("delivery").textContent = delivery;
      
      if (week === 36) {
        // Quiz
        const estimated = parseInt(el("estimatedScore").value);
        const answers = {
          q1: el("q1").value,
          q2: el("q2").value,
          q3: el("q3").value,
          q4: el("q4").value,
          q5: el("q5").value
        };
        const correctAnswers = ["Canberra","96","1998","Silver","Tanzania"];
        let quizScore = 0;
        correctAnswers.forEach((ans,i)=>{
          if (answers["q"+(i+1)] === ans) quizScore++;
        });
        const overestimation = (estimated - quizScore);
        let overplacementScore = 0;
        switch(el("placement").value) {
          case "Top 10%": overplacementScore = 90; break;
          case "Top 25%": overplacementScore = 75; break;
          case "Average": overplacementScore = 50; break;
          case "Bottom 25%": overplacementScore = 25; break;
          case "Bottom 10%": overplacementScore = 10; break;
        }
        // Overprecision
        const ranges = {
          phoneMin: +el("phoneMin").value,   phoneMax: +el("phoneMax").value,
          romeMin:  +el("romeMin").value,    romeMax:  +el("romeMax").value,
          bloodMin: +el("bloodMin").value,   bloodMax: +el("bloodMax").value,
          weeksMin: +el("weeksMin").value,   weeksMax: +el("weeksMax").value,
          moonMin:  +el("moonMin").value,    moonMax:  +el("moonMax").value,
          poolMin:  +el("poolMin").value,    poolMax:  +el("poolMax").value,
          radiusMin:+el("radiusMin").value,  radiusMax:+el("radiusMax").value,
          wallMin:  +el("wallMin").value,    wallMax:  +el("wallMax").value,
          secondsMin:+el("secondsMin").value,secondsMax:+el("secondsMax").value,
          franceMin: +el("franceMin").value, franceMax: +el("franceMax").value
        };
        let correctCount = 0;
        Object.keys(ranges).forEach(key => {
          if (key.endsWith("Min")) {
            const base = TRUE_VALUES[key.replace("Min","")];
            if (ranges[key] <= base && ranges[key.replace("Min","Max")] >= base) {
              correctCount++;
            }
          }
        });
        const overprecisionScore = (((0.9*10)-correctCount) / 10) * 100;
        const oci = (overestimation + overplacementScore + overprecisionScore) / 3;

        // Payload
        const payload = {
            nickname,
            code: userCode,
            gender,
            age,
            education,
            nationality,
            supplyChainConf,
            estimatedScore: estimated,
            quizAnswers: answers,
            placement: el("placement").value,
            overprecisionRanges: ranges,
            quizScore,
            correctCount,
            overestimation,
            overplacementScore,
            overprecisionScore,
            oci,
            totalCost,
            orders   
        };
        fetch(
          "https://script.google.com/macros/s/AKfycbwJU4iJM9LxfrFLxsDcOvYvFDf52_u0xTXCFn_SHJlKCLjGFXv9lC27ld_xjr0SZuqm/exec",
          { method:"POST", mode:"no-cors",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify(payload)
          }
        );


        alert(
        currentLang === "it"
          ? "IL TUO GIOCO SI CONCLUDE QUA. ANCHE SE VISUALIZZAVI 50 SETTIMANE LA 36ESIMA ERA L'ULTIMA. QUESTO È STATO FATTO PER EVITARE CHE IL NUMERO DI SETTIMANE INFLUENZASSE LE TUE SCELTE"
          : "YOUR GAME ENDS HERE. EVEN IF YOU SAW 50 WEEKS, THE 36TH WAS THE LAST. THIS WAS DONE TO AVOID THE NUMBER OF WEEKS INFLUENCING YOUR CHOICES"
        );

        // Show final
el("thankYou").textContent = translations[currentLang].thankYou;
const row = document.createElement("tr");

// usa confidenceLabel per tradurre il valore numerico in testo
const overestLabel = confidenceLabel(overestimation);
const overprecLabel = confidenceLabel(overprecisionScore);

row.innerHTML = `
  <td>${nickname}</td>
  <td>${overestLabel}</td>
  <td>${overprecLabel}</td>
  <td>€${totalCost.toFixed(2)}</td>`;
el("resultsTable").appendChild(row);
hide("gameSection");
show("finalResults");
        return;
      }
      week++;
      updateProgressBar();
    }

    function updateProgressBar() {
      const pct = Math.min((week/50)*100,100);
      el("progressFill").style.width = pct + "%";
      el("progressLabel").textContent = `Week: ${week} / 50`;
    }

    function loadXlsxData() {
      const tbody = el("adminTable");
      tbody.innerHTML = "";
      fetch(SHEET_XLSX_URL)
        .then(r => { if(!r.ok) throw new Error("Errore XLSX"); return r.arrayBuffer(); })
        .then(buf => {
          const wb = XLSX.read(new Uint8Array(buf), {type:"array"});
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
          if (rows.length<2) {
            tbody.innerHTML = `<tr><td colspan="6">${currentLang==="it"?"Nessun dato":"No data"}</td></tr>`;
            return;
          }
          for (let i=1; i<rows.length; i++) {
            const c = rows[i];
            if (!c[0]) continue;
            const overest = c[21]||"", overplac = c[22]||"",
                  overprec = c[23]||"", oci = c[24]||"",
                  tot = c[19]||"";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${c[0]}</td><td>${overest}%</td>
              <td>${overplac}%</td><td>${overprec}%</td>
              <td>${oci}%</td><td>€${tot}</td>`;
            tbody.appendChild(tr);
          }
        })
        .catch(()=> {
          tbody.innerHTML = `<tr><td colspan="6">${currentLang==="it"?"Impossibile caricare dati":"Unable to load data"}</td></tr>`;
        });
    }

    function downloadSheet() {
      window.open(SHEET_XLSX_URL, "_blank");
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      el("nickname").addEventListener("keypress", e=>{
        if (e.key==="Enter") startOverestimation();
      });
    });

    // Admin override
    const _orig = startOverestimation;
    startOverestimation = function(){
      const n = el("nickname").value.trim();
      if (n==="admin") {
        const pw = prompt(currentLang==="it"?"Inserisci password:":"Enter password:");
        if (pw==="password") {
          hide("nicknameSection");
          show("adminSection");
          loadXlsxData();
          return;
        } else {
          alert(currentLang==="it"?"Password errata":"Wrong password");
          return;
        }
      }
      _orig();
    };
  </script>
</body>
</html>
